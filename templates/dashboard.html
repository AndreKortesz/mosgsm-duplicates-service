{% extends "base.html" %}

{% block title %}–û–±—â–∏–π –¥–∞—à–±–æ—Ä–¥ - MOS-GSM{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">üìä –û–±—â–∏–π –¥–∞—à–±–æ—Ä–¥</h1>
        <div class="space-x-4">
            <a href="/" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                + –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
            </a>
            <a href="/ui/files" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                üìÅ –í—Å–µ —Ñ–∞–π–ª—ã
            </a>
        </div>
    </div>

    <!-- –ü–æ–∏—Å–∫–æ–≤–∏–∫ -->
    <div class="bg-gray-800 rounded-lg shadow-2xl p-6 mb-6 border border-gray-700">
        <h2 class="text-xl font-semibold text-white mb-4">üîç –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º —Ñ–∞–π–ª–∞–º</h2>
        <form id="searchForm" class="flex gap-4">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞, –∞–¥—Ä–µ—Å, —Å—É–º–º—É –∏–ª–∏ –ª—é–±–æ–µ —Å–ª–æ–≤–æ..."
                class="flex-1 bg-gray-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
            >
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors">
                –ò—Å–∫–∞—Ç—å
            </button>
        </form>
        <div id="searchResults" class="mt-4 hidden"></div>
    </div>

    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤</div>
            <div class="text-2xl font-bold text-white" id="totalFiles">-</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
            <div class="text-2xl font-bold text-green-400" id="totalOrders">-</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö</div>
            <div class="text-2xl font-bold text-yellow-400" id="problematicCount">-</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">üî¥ –î—É–±–ª–µ–π</div>
            <div class="text-2xl font-bold text-red-400" id="duplicatesCount">-</div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">üü° –ö–æ–º–±–æ</div>
            <div class="text-2xl font-bold text-yellow-400" id="comboCount">-</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">üîµ –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
            <div class="text-2xl font-bold text-blue-400" id="reviewCount">-</div>
        </div>
    </div>

    <!-- –¢–∞–±—ã -->
    <div class="bg-gray-800 rounded-lg shadow-2xl border border-gray-700">
        <div class="border-b border-gray-700">
            <nav class="flex space-x-4 px-6" role="tablist">
                <button class="tab-btn py-4 px-4 font-semibold border-b-2 border-blue-500 text-blue-400" data-tab="duplicates">
                    üî¥ –î—É–±–ª–∏
                </button>
                <button class="tab-btn py-4 px-4 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white" data-tab="combo">
                    üü° –ö–æ–º–±–æ
                </button>
                <button class="tab-btn py-4 px-4 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white" data-tab="review">
                    üîµ –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
                </button>
                <button class="tab-btn py-4 px-4 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white" data-tab="problematic">
                    ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ
                </button>
            </nav>
        </div>

        <div class="p-6">
            <div id="tab-duplicates" class="tab-content"></div>
            <div id="tab-combo" class="tab-content hidden"></div>
            <div id="tab-review" class="tab-content hidden"></div>
            <div id="tab-problematic" class="tab-content hidden"></div>
        </div>
    </div>
</div>

<script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞
    async function loadDashboard() {
        try {
            const response = await fetch('/api/dashboard/all');
            const data = await response.json();
            
            document.getElementById('totalFiles').textContent = data.total_files;
            document.getElementById('totalOrders').textContent = data.total_orders;
            document.getElementById('problematicCount').textContent = data.problematic_count;
            document.getElementById('duplicatesCount').textContent = data.hard_duplicates_count;
            document.getElementById('comboCount').textContent = data.combo_clusters_count;
            document.getElementById('reviewCount').textContent = data.needs_review_count;
            
            displayDuplicates(data.analysis.hard_duplicates_sample);
            displayCombo(data.analysis.combo_clusters_sample);
            displayReview(data.analysis.needs_review_sample);
            displayProblematic(data.analysis.problematic_sample);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞:', error);
        }
    }

    function displayDuplicates(duplicates) {
        const container = document.getElementById('tab-duplicates');
        if (!duplicates || duplicates.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">‚úÖ –ñ—ë—Å—Ç–∫–∏—Ö –¥—É–±–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
            return;
        }
        
        container.innerHTML = duplicates.map(dup => `
            <div class="bg-gray-700 rounded-lg p-4 mb-3 border border-red-500/30">
                <div class="mb-3">
                    <div class="font-bold text-white">${dup.order_number}</div>
                    <div class="text-gray-300 text-sm">${dup.address}</div>
                    <div class="text-gray-400 text-sm mt-1">–¢–∏–ø: ${translateWorkType(dup.work_type)}</div>
                </div>
                <div class="space-y-2">
                    ${dup.rows.map(row => `
                        <div class="bg-gray-600 rounded p-3 text-sm">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="text-white">üë§ ${row.worker_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                                    <span class="text-gray-400 ml-2">| –§–∞–π–ª ID: ${row.file_id}</span>
                                </div>
                                <span class="text-green-400 font-bold">üí∞ ${row.payout ? row.payout.toFixed(2) + ' ‚ÇΩ' : '-'}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function displayCombo(combos) {
        const container = document.getElementById('tab-combo');
        if (!combos || combos.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">–ö–æ–º–±–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
            return;
        }
        
        container.innerHTML = combos.map(combo => `
            <div class="bg-gray-700 rounded-lg p-4 mb-3 border border-yellow-500/30">
                <div class="mb-3">
                    <div class="text-gray-300 text-sm font-semibold">${combo.address}</div>
                    ${combo.order_numbers.length > 0 ? `
                        <div class="text-gray-400 text-sm">–ó–∞–∫–∞–∑—ã: ${combo.order_numbers.join(', ')}</div>
                    ` : ''}
                </div>
                <div class="space-y-2">
                    ${combo.rows.map(row => `
                        <div class="bg-gray-600 rounded p-3 text-sm">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="text-white">${translateWorkType(row.work_type)}</span>
                                    <span class="text-gray-400 ml-2">| üë§ ${row.worker_name || '-'}</span>
                                    <span class="text-gray-400 ml-2">| –ó–∞–∫–∞–∑: ${row.order_number || '‚ùå –ù–µ—Ç'}</span>
                                    <span class="text-gray-400 ml-2">| –§–∞–π–ª: ${row.file_id}</span>
                                </div>
                                <span class="text-green-400 font-bold">üí∞ ${row.payout ? row.payout.toFixed(2) + ' ‚ÇΩ' : '-'}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function displayReview(reviews) {
        const container = document.getElementById('tab-review');
        if (!reviews || reviews.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">‚úÖ –ó–∞–∫–∞–∑–æ–≤ —Ç—Ä–µ–±—É—é—â–∏—Ö –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
            return;
        }
        
        container.innerHTML = reviews.map(review => `
            <div class="bg-gray-700 rounded-lg p-4 mb-3 border border-blue-500/30">
                <div class="mb-3">
                    <div class="font-bold text-white">–ó–∞–∫–∞–∑: ${review.order_number}</div>
                    <div class="text-yellow-400 text-sm">‚ö†Ô∏è –†–∞–∑–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞!</div>
                    <div class="text-gray-400 text-sm mt-2">–ê–¥—Ä–µ—Å–∞:</div>
                    <ul class="list-disc list-inside text-gray-300 text-sm ml-4">
                        ${review.addresses.map(addr => `<li>${addr}</li>`).join('')}
                    </ul>
                </div>
                <div class="space-y-2">
                    ${review.rows.map(row => `
                        <div class="bg-gray-600 rounded p-3 text-sm">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="text-white">üìç ${row.address || '‚ùå –ù–µ—Ç'}</span>
                                    <span class="text-gray-400 ml-2">| üë§ ${row.worker_name || '-'}</span>
                                    <span class="text-gray-400 ml-2">| –§–∞–π–ª: ${row.file_id}</span>
                                </div>
                                <span class="text-green-400 font-bold">üí∞ ${row.payout ? row.payout.toFixed(2) + ' ‚ÇΩ' : '-'}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function displayProblematic(problematic) {
        const container = document.getElementById('tab-problematic');
        if (!problematic || problematic.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">‚úÖ –ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
            return;
        }
        
        container.innerHTML = problematic.map(row => `
            <div class="bg-gray-700 rounded-lg p-4 mb-3 border border-yellow-500/30">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                    <div>
                        <span class="text-gray-400">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</span>
                        <span class="text-white font-semibold">${row.order_number || '‚ùå –ù–µ—Ç'}</span>
                    </div>
                    <div>
                        <span class="text-gray-400">–ê–¥—Ä–µ—Å:</span>
                        <span class="text-white font-semibold">${row.address || '‚ùå –ù–µ—Ç'}</span>
                    </div>
                    <div>
                        <span class="text-gray-400">–°—É–º–º–∞:</span>
                        <span class="text-green-400 font-semibold">${row.payout ? row.payout.toFixed(2) + ' ‚ÇΩ' : '-'}</span>
                    </div>
                </div>
                <div class="mt-2 text-gray-300 text-sm">
                    <span class="text-gray-400">üë§ –ú–æ–Ω—Ç–∞–∂–Ω–∏–∫:</span> ${row.worker_name || '-'}
                    <span class="text-gray-400 ml-4">| –§–∞–π–ª ID:</span> ${row.file_id}
                </div>
                <div class="mt-2 text-gray-300 text-sm">
                    <span class="text-gray-400">–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:</span> ${row.raw_text || '-'}
                </div>
            </div>
        `).join('');
    }

    // –ü–æ–∏—Å–∫
    document.getElementById('searchForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = document.getElementById('searchInput').value;
        const resultsDiv = document.getElementById('searchResults');
        
        resultsDiv.innerHTML = '<p class="text-gray-400">–ü–æ–∏—Å–∫...</p>';
        resultsDiv.classList.remove('hidden');
        
        try {
            const response = await fetch(`/api/search?query=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data.total === 0) {
                resultsDiv.innerHTML = '<p class="text-gray-500">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                return;
            }
            
            resultsDiv.innerHTML = `
                <div class="bg-gray-700 rounded-lg p-4">
                    <p class="text-white font-semibold mb-4">–ù–∞–π–¥–µ–Ω–æ: ${data.total} –∑–∞–ø–∏—Å–µ–π</p>
                    ${data.by_file.map(fileGroup => `
                        <div class="mb-4">
                            <div class="text-blue-400 font-semibold mb-2">
                                üìÅ ${fileGroup.file.filename} (${fileGroup.file.uploaded_at})
                            </div>
                            <div class="space-y-2">
                                ${fileGroup.results.map(row => `
                                    <div class="bg-gray-600 rounded p-3 text-sm">
                                        <div class="text-white">
                                            ${row.order_number || '‚ùå –ù–µ—Ç –∑–∞–∫–∞–∑–∞'} | ${row.address || '‚ùå –ù–µ—Ç –∞–¥—Ä–µ—Å–∞'}
                                        </div>
                                        <div class="text-gray-400">
                                            üë§ ${row.worker_name || '-'} | 
                                            üí∞ ${row.payout ? row.payout.toFixed(2) + ' ‚ÇΩ' : '-'} |
                                            ${translateWorkType(row.work_type)}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } catch (error) {
            resultsDiv.innerHTML = '<p class="text-red-400">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</p>';
        }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.tab;
            
            tabBtns.forEach(b => {
                b.classList.remove('border-blue-500', 'text-blue-400');
                b.classList.add('border-transparent', 'text-gray-400');
            });
            
            btn.classList.add('border-blue-500', 'text-blue-400');
            btn.classList.remove('border-transparent', 'text-gray-400');
            
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        });
    });

    function translateWorkType(type) {
        const types = {
            'diagnostic': 'üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞',
            'inspection': 'üëÅÔ∏è –û—Å–º–æ—Ç—Ä',
            'installation': 'üîß –ú–æ–Ω—Ç–∞–∂',
            'other': '‚ùì –î—Ä—É–≥–æ–µ'
        };
        return types[type] || type;
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadDashboard();
</script>
{% endblock %}
