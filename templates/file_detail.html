{% extends "base.html" %}

{% block title %}{{ file.filename }} - MOS-GSM{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- –®–∞–ø–∫–∞ -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <a href="/ui/files" class="text-blue-400 hover:text-blue-300 text-sm mb-2 inline-block">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
            <h1 class="text-3xl font-bold">{{ file.filename }}</h1>
            <p class="text-gray-400 text-sm">–ó–∞–≥—Ä—É–∂–µ–Ω: {{ file.uploaded_at.strftime('%d.%m.%Y %H:%M') }}</p>
        </div>
        <button onclick="deleteFile()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
            üóë –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
        </button>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
            <div class="text-2xl font-bold text-white">{{ total_rows }}</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö</div>
            <div class="text-2xl font-bold text-yellow-400">{{ analysis.problematic_count }}</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">üî¥ –î—É–±–ª–µ–π</div>
            <div class="text-2xl font-bold text-red-400">{{ analysis.hard_duplicates_count }}</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">üü° –ö–æ–º–±–æ</div>
            <div class="text-2xl font-bold text-yellow-400">{{ analysis.combo_clusters_count }}</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">üìä –ö–ª–∞—Å—Ç–µ—Ä–æ–≤</div>
            <div class="text-2xl font-bold text-blue-400">{{ analysis.clusters_with_multiple_count }}</div>
        </div>
    </div>

    <!-- –¢–∞–±—ã -->
    <div class="bg-gray-800 rounded-lg shadow-2xl border border-gray-700">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ç–∞–±–æ–≤ -->
        <div class="border-b border-gray-700">
            <nav class="flex space-x-4 px-6" role="tablist">
                <button class="tab-btn py-4 px-4 font-semibold border-b-2 border-blue-500 text-blue-400" data-tab="problematic">
                    ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ ({{ analysis.problematic_count }})
                </button>
                <button class="tab-btn py-4 px-4 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white" data-tab="hard">
                    üî¥ –ñ—ë—Å—Ç–∫–∏–µ –¥—É–±–ª–∏ ({{ analysis.hard_duplicates_count }})
                </button>
                <button class="tab-btn py-4 px-4 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white" data-tab="combo">
                    üü° –ö–æ–º–±–æ ({{ analysis.combo_clusters_count }})
                </button>
            </nav>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Ç–∞–±–æ–≤ -->
        <div class="p-6">
            <!-- –¢–∞–±: –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ -->
            <div id="tab-problematic" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏</h2>
                    <a href="/api/files/{{ file_id }}/export/problematic" class="text-blue-400 hover:text-blue-300">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
                </div>
                <p class="text-gray-400 mb-4 text-sm">–°—Ç—Ä–æ–∫–∏ –±–µ–∑ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞ –∏–ª–∏ –∞–¥—Ä–µ—Å–∞. –¢—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏!</p>
                
                {% if analysis.problematic_sample %}
                <div class="space-y-3">
                    {% for row in analysis.problematic_sample %}
                    <div class="bg-gray-700 rounded-lg p-4 border border-yellow-500/30">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                            <div>
                                <span class="text-gray-400">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</span>
                                <span class="text-white font-semibold">{{ row.order_number or '‚ùå –ù–µ—Ç' }}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">–ê–¥—Ä–µ—Å:</span>
                                <span class="text-white font-semibold">{{ row.address or '‚ùå –ù–µ—Ç' }}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">–°—É–º–º–∞:</span>
                                <span class="text-green-400 font-semibold">{{ '{:,.2f}'.format(row.payout) if row.payout else '-' }} ‚ÇΩ</span>
                            </div>
                        </div>
                        <div class="mt-2 text-gray-300 text-sm">
                            <span class="text-gray-400">–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:</span> {{ row.raw_text or '-' }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-8">‚úÖ –ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                {% endif %}
            </div>

            <!-- –¢–∞–±: –ñ—ë—Å—Ç–∫–∏–µ –¥—É–±–ª–∏ -->
            <div id="tab-hard" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">–ñ—ë—Å—Ç–∫–∏–µ –¥—É–±–ª–∏</h2>
                    <a href="/api/files/{{ file_id }}/export/hard" class="text-blue-400 hover:text-blue-300">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
                </div>
                <p class="text-gray-400 mb-4 text-sm">–û–¥–∏–Ω–∞–∫–æ–≤—ã–π –∑–∞–∫–∞–∑ + –∞–¥—Ä–µ—Å + —Ç–∏–ø —Ä–∞–±–æ—Ç—ã. –†–∏—Å–∫ –¥–≤–æ–π–Ω–æ–π –æ–ø–ª–∞—Ç—ã!</p>
                
                {% if analysis.hard_duplicates_sample %}
                <div class="space-y-4">
                    {% for dup in analysis.hard_duplicates_sample %}
                    <div class="bg-gray-700 rounded-lg p-4 border border-red-500/30">
                        <div class="mb-3">
                            <div class="font-bold text-white">{{ dup.order_number }}</div>
                            <div class="text-gray-300 text-sm">{{ dup.address }}</div>
                            <div class="text-gray-400 text-sm mt-1">–¢–∏–ø: 
                                {% if dup.work_type == 'diagnostic' %}üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                                {% elif dup.work_type == 'inspection' %}üëÅÔ∏è –û—Å–º–æ—Ç—Ä
                                {% elif dup.work_type == 'installation' %}üîß –ú–æ–Ω—Ç–∞–∂
                                {% else %}‚ùì –î—Ä—É–≥–æ–µ{% endif %}
                            </div>
                        </div>
                        <div class="space-y-2">
                            {% for row in dup.rows %}
                            <div class="bg-gray-600 rounded p-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-white">üë§ {{ row.worker_name or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span>
                                    <span class="text-green-400 font-bold">üí∞ {{ '{:,.2f}'.format(row.payout) if row.payout else '-' }} ‚ÇΩ</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-8">‚úÖ –ñ—ë—Å—Ç–∫–∏—Ö –¥—É–±–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                {% endif %}
            </div>

            <!-- –¢–∞–±: –ö–æ–º–±–æ -->
            <div id="tab-combo" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">–ö–æ–º–±–æ (–æ—Å–º–æ—Ç—Ä + –º–æ–Ω—Ç–∞–∂)</h2>
                    <a href="/api/files/{{ file_id }}/export/combo" class="text-blue-400 hover:text-blue-300">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
                </div>
                <p class="text-gray-400 mb-4 text-sm">–ù–æ—Ä–º–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏: —Å–Ω–∞—á–∞–ª–∞ –æ—Å–º–æ—Ç—Ä/–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –ø–æ—Ç–æ–º –º–æ–Ω—Ç–∞–∂</p>
                
                {% if analysis.combo_clusters_sample %}
                <div class="space-y-4">
                    {% for combo in analysis.combo_clusters_sample %}
                    <div class="bg-gray-700 rounded-lg p-4 border border-yellow-500/30">
                        <div class="mb-3">
                            <div class="font-bold text-white">{{ combo.order_number }}</div>
                            <div class="text-gray-300 text-sm">{{ combo.address }}</div>
                        </div>
                        <div class="space-y-2">
                            {% for row in combo.rows %}
                            <div class="bg-gray-600 rounded p-3 text-sm">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="text-white">
                                            {% if row.work_type == 'diagnostic' %}üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                                            {% elif row.work_type == 'inspection' %}üëÅÔ∏è –û—Å–º–æ—Ç—Ä
                                            {% elif row.work_type == 'installation' %}üîß –ú–æ–Ω—Ç–∞–∂
                                            {% else %}‚ùì –î—Ä—É–≥–æ–µ{% endif %}
                                        </span>
                                        <span class="text-gray-400 ml-2">| üë§ {{ row.worker_name or '-' }}</span>
                                    </div>
                                    <span class="text-green-400 font-bold">üí∞ {{ '{:,.2f}'.format(row.payout) if row.payout else '-' }} ‚ÇΩ</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-8">–ö–æ–º–±–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.tab;
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            tabBtns.forEach(b => {
                b.classList.remove('border-blue-500', 'text-blue-400');
                b.classList.add('border-transparent', 'text-gray-400');
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ
            btn.classList.add('border-blue-500', 'text-blue-400');
            btn.classList.remove('border-transparent', 'text-gray-400');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ç–∞–±—ã
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —Ç–∞–±
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        });
    });

    async function deleteFile() {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª –∏ –≤—Å–µ –µ–≥–æ –∑–∞–ø–∏—Å–∏?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) return;
        
        try {
            const response = await fetch(`/api/files/{{ file_id }}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                alert('–§–∞–π–ª —É–¥–∞–ª—ë–Ω');
                window.location.href = '/ui/files';
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }
</script>
{% endblock %}
