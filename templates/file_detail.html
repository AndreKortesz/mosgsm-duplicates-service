{% extends "base.html" %}

{% block title %}{{ file.filename }} - Mos-GSM{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- –®–∞–ø–∫–∞ -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <a href="/ui/files" class="text-blue-400 hover:text-blue-300 text-sm mb-2 inline-block">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
            <h1 class="text-3xl font-bold">{{ file.filename }}</h1>
            <p class="text-gray-400 text-sm">–ó–∞–≥—Ä—É–∂–µ–Ω: {{ file.uploaded_at.strftime('%d.%m.%Y %H:%M') }}</p>
        </div>
        <button onclick="deleteFile()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
            üóë –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
        </button>
    </div>

    <!-- –õ–æ–≥–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ -->
    <div id="parseLogsBlock" class="hidden bg-red-900/30 border border-red-500 rounded-lg p-4 mb-6">
        <h2 class="text-lg font-bold text-red-400 mb-2">‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞</h2>
        <div id="parseLogsList"></div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
            <div class="text-2xl font-bold text-white">{{ total_rows }}</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö</div>
            <div class="text-2xl font-bold text-yellow-400">{{ analysis.problematic_count }}</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">üî¥ –î—É–±–ª–µ–π</div>
            <div class="text-2xl font-bold text-red-400">{{ analysis.hard_duplicates_count }}</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">üü° –ö–æ–º–±–æ</div>
            <div class="text-2xl font-bold text-yellow-400">{{ analysis.combo_clusters_count }}</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="text-gray-400 text-sm">üîµ –ü—Ä–æ–≤–µ—Ä–∫–∏</div>
            <div class="text-2xl font-bold text-blue-400">{{ analysis.needs_review_count }}</div>
        </div>
    </div>

    <!-- –¢–∞–±—ã -->
    <div class="bg-gray-800 rounded-lg shadow-2xl border border-gray-700">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ç–∞–±–æ–≤ -->
        <div class="border-b border-gray-700">
            <nav class="flex space-x-4 px-6" role="tablist">
                <button class="tab-btn py-4 px-4 font-semibold border-b-2 border-blue-500 text-blue-400" data-tab="problematic">
                    ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ ({{ analysis.problematic_count }})
                </button>
                <button class="tab-btn py-4 px-4 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white" data-tab="hard">
                    üî¥ –ñ—ë—Å—Ç–∫–∏–µ –¥—É–±–ª–∏ ({{ analysis.hard_duplicates_count }})
                </button>
                <button class="tab-btn py-4 px-4 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white" data-tab="combo">
                    üü° –ö–æ–º–±–æ ({{ analysis.combo_clusters_count }})
                </button>
                <button class="tab-btn py-4 px-4 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white" data-tab="review">
                    üîµ –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ ({{ analysis.needs_review_count }})
                </button>
            </nav>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Ç–∞–±–æ–≤ -->
        <div class="p-6">
            <!-- –¢–∞–±: –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ -->
            <div id="tab-problematic" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏</h2>
                    <a href="/api/files/{{ file_id }}/export/problematic" class="text-blue-400 hover:text-blue-300">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
                </div>
                <p class="text-gray-400 mb-4 text-sm">–°—Ç—Ä–æ–∫–∏ –±–µ–∑ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞ –∏–ª–∏ –∞–¥—Ä–µ—Å–∞. –¢—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏!</p>
                
                {% if analysis.problematic_sample %}
                <div class="space-y-3">
                    {% for row in analysis.problematic_sample %}
                    <div class="bg-gray-700 rounded-lg p-4 border border-yellow-500/30">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                            <div>
                                <span class="text-gray-400">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</span>
                                <span class="text-white font-semibold">{{ row.order_number or '‚ùå –ù–µ—Ç' }}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">–ê–¥—Ä–µ—Å:</span>
                                <span class="text-white font-semibold">{{ row.address or '‚ùå –ù–µ—Ç' }}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">–°—É–º–º–∞:</span>
                                <span class="text-green-400 font-semibold">{{ '{:,.2f}'.format(row.payout) if row.payout else '-' }} ‚ÇΩ</span>
                            </div>
                        </div>
                        <div class="mt-2 text-gray-300 text-sm">
                            <span class="text-gray-400">üë§ –ú–æ–Ω—Ç–∞–∂–Ω–∏–∫:</span> {{ row.worker_name or '-' }}
                        </div>
                        <div class="mt-2 text-gray-300 text-sm">
                            <span class="text-gray-400">–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:</span> {{ row.raw_text or '-' }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-8">‚úÖ –ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                {% endif %}
            </div>

            <!-- –¢–∞–±: –ñ—ë—Å—Ç–∫–∏–µ –¥—É–±–ª–∏ -->
            <div id="tab-hard" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">–ñ—ë—Å—Ç–∫–∏–µ –¥—É–±–ª–∏</h2>
                    <a href="/api/files/{{ file_id }}/export/hard" class="text-blue-400 hover:text-blue-300">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
                </div>
                <p class="text-gray-400 mb-4 text-sm">–û–¥–∏–Ω–∞–∫–æ–≤—ã–π –∑–∞–∫–∞–∑ + –∞–¥—Ä–µ—Å + —Ç–∏–ø —Ä–∞–±–æ—Ç—ã. –†–∏—Å–∫ –¥–≤–æ–π–Ω–æ–π –æ–ø–ª–∞—Ç—ã!</p>
                
                {% if analysis.hard_duplicates_sample %}
                <div class="space-y-4">
                    {% for dup in analysis.hard_duplicates_sample %}
                    <div class="bg-gray-700 rounded-lg p-4 border border-red-500/30">
                        <div class="mb-3">
                            <div class="font-bold text-white">{{ dup.order_number }}</div>
                            <div class="text-gray-300 text-sm">{{ dup.address }}</div>
                            <div class="text-gray-400 text-sm mt-1">–¢–∏–ø: 
                                {% if dup.work_type == 'diagnostic' %}üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                                {% elif dup.work_type == 'inspection' %}üëÅÔ∏è –û—Å–º–æ—Ç—Ä
                                {% elif dup.work_type == 'installation' %}üîß –ú–æ–Ω—Ç–∞–∂
                                {% else %}‚ùì –î—Ä—É–≥–æ–µ{% endif %}
                            </div>
                        </div>
                        <div class="space-y-2">
                            {% for row in dup.rows %}
                            <div class="bg-gray-600 rounded p-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-white">üë§ {{ row.worker_name or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span>
                                    <span class="text-green-400 font-bold">üí∞ {{ '{:,.2f}'.format(row.payout) if row.payout else '-' }} ‚ÇΩ</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-8">‚úÖ –ñ—ë—Å—Ç–∫–∏—Ö –¥—É–±–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                {% endif %}
            </div>

            <!-- –¢–∞–±: –ö–æ–º–±–æ -->
            <div id="tab-combo" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">–ö–æ–º–±–æ (—Å—Ö–æ–∂–∏–µ –∞–¥—Ä–µ—Å–∞)</h2>
                    <a href="/api/files/{{ file_id }}/export/combo" class="text-blue-400 hover:text-blue-300">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
                </div>
                <p class="text-gray-400 mb-4 text-sm">–°—Ö–æ–∂–∏–µ –∞–¥—Ä–µ—Å–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –∑–∞–∫–∞–∑–∞–º–∏ –∏–ª–∏ —Ç–∏–ø–∞–º–∏ —Ä–∞–±–æ—Ç</p>
                
                {% if analysis.combo_clusters_sample %}
                <div class="space-y-4">
                    {% for combo in analysis.combo_clusters_sample %}
                    <div class="bg-gray-700 rounded-lg p-4 border border-yellow-500/30">
                        <div class="mb-3">
                            <div class="text-gray-300 text-sm font-semibold">üìç {{ combo.address }}</div>
                            {% if combo.order_numbers %}
                                <div class="text-gray-400 text-sm">–ó–∞–∫–∞–∑—ã: {{ ', '.join(combo.order_numbers) }}</div>
                            {% endif %}
                        </div>
                        <div class="space-y-2">
                            {% for row in combo.rows %}
                            <div class="bg-gray-600 rounded p-3 text-sm">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="text-white">
                                            {% if row.work_type == 'diagnostic' %}üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                                            {% elif row.work_type == 'inspection' %}üëÅÔ∏è –û—Å–º–æ—Ç—Ä
                                            {% elif row.work_type == 'installation' %}üîß –ú–æ–Ω—Ç–∞–∂
                                            {% else %}‚ùì –î—Ä—É–≥–æ–µ{% endif %}
                                        </span>
                                        <span class="text-gray-400 ml-2">| üë§ {{ row.worker_name or '-' }}</span>
                                        <span class="text-gray-400 ml-2">| –ó–∞–∫–∞–∑: {{ row.order_number or '‚ùå –ù–µ—Ç' }}</span>
                                    </div>
                                    <span class="text-green-400 font-bold">üí∞ {{ '{:,.2f}'.format(row.payout) if row.payout else '-' }} ‚ÇΩ</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-8">–ö–æ–º–±–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                {% endif %}
            </div>

            <!-- –¢–∞–±: –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
            <div id="tab-review" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">–¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</h2>
                    <a href="/api/files/{{ file_id }}/export/review" class="text-blue-400 hover:text-blue-300">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
                </div>
                <p class="text-gray-400 mb-4 text-sm">–û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ –∞–¥—Ä–µ—Å–∞–º–∏</p>
                
                {% if analysis.needs_review_sample %}
                <div class="space-y-4">
                    {% for review in analysis.needs_review_sample %}
                    <div class="bg-gray-700 rounded-lg p-4 border border-blue-500/30">
                        <div class="mb-3">
                            <div class="font-bold text-white">–ó–∞–∫–∞–∑: {{ review.order_number }}</div>
                            <div class="text-yellow-400 text-sm">‚ö†Ô∏è –†–∞–∑–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞!</div>
                            <div class="text-gray-400 text-sm mt-2">–ê–¥—Ä–µ—Å–∞:</div>
                            <ul class="list-disc list-inside text-gray-300 text-sm ml-4">
                                {% for addr in review.addresses %}
                                <li>{{ addr }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="space-y-2">
                            {% for row in review.rows %}
                            <div class="bg-gray-600 rounded p-3 text-sm">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="text-white">üìç {{ row.address or '‚ùå –ù–µ—Ç' }}</span>
                                        <span class="text-gray-400 ml-2">| üë§ {{ row.worker_name or '-' }}</span>
                                    </div>
                                    <span class="text-green-400 font-bold">üí∞ {{ '{:,.2f}'.format(row.payout) if row.payout else '-' }} ‚ÇΩ</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-8">‚úÖ –ó–∞–∫–∞–∑–æ–≤ —Ç—Ä–µ–±—É—é—â–∏—Ö –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.tab;
            
            tabBtns.forEach(b => {
                b.classList.remove('border-blue-500', 'text-blue-400');
                b.classList.add('border-transparent', 'text-gray-400');
            });
            
            btn.classList.add('border-blue-500', 'text-blue-400');
            btn.classList.remove('border-transparent', 'text-gray-400');
            
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        });
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤ –ø–∞—Ä—Å–∏–Ω–≥–∞
    async function loadParseLogs() {
        try {
            const response = await fetch(`/api/files/{{ file_id }}/parse-logs`);
            const data = await response.json();
            
            if (data.logs && data.logs.length > 0) {
                document.getElementById('parseLogsBlock').classList.remove('hidden');
                document.getElementById('parseLogsList').innerHTML = data.logs.map(log => `
                    <div class="text-sm ${log.type === 'error' ? 'text-red-300' : 'text-yellow-300'} mb-1">
                        <span class="font-mono text-xs text-gray-400">${log.created_at}</span> - ${log.message}
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', error);
        }
    }

    async function deleteFile() {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª –∏ –≤—Å–µ –µ–≥–æ –∑–∞–ø–∏—Å–∏?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) return;
        
        try {
            const response = await fetch(`/api/files/{{ file_id }}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                alert('–§–∞–π–ª —É–¥–∞–ª—ë–Ω');
                window.location.href = '/ui/files';
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }

    // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadParseLogs();
</script>
{% endblock %}
